\documentclass[a4paper,14pt]{extreport}

\usepackage{float}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{./diss_style}

% NOTE: Check for � always! They seem to creep up.

% Bibliography style
\usepackage[
style=gost-numeric, %or just numeric
backend=biber,
%sorting=ynt,
language=auto
]{biblatex}

\addbibresource{citations.bib}

% Оформление глав, разделов и т.д.
\makeatletter

% Values

\title{Разработка алгоритмов машинного обучения для построения моделей с переключением состояний}
\authorlast{Макаревич}
\authorfirst{Анатолий Сергеевич}
\author{\@authorlast \@authorfirst}

\mentor{Малюгин Владимир Ильич}
\mentorjob{доцент, кандидат физико-математических наук, кафедра ММАД}
\faculty{Факультет Прикладной Математики и Информатики}
\subfaculty{Кафедра Математического Моделирования и Анализа Данных}
\specialty{ПКАД (Прикладной Компьютерный Анализ Данных)}

\begin{document}

% Create title page
\maketitle

\selectlanguage{russian}

% Общая характеристика работы
% «Общая характеристика работы» содержит:
% перечень ключевых слов; 
% цель, задачи, объект и предмет исследования;
% формулировку полученных результатов и их новизну;
% сведения о структуре магистерской диссертации. 
% Перечень ключевых слов характеризует основное содержание магистерской диссертации и включает 10-15 слов в именител/ьном падеже, написанных через запятую в строку прописными буквами. 

\fakechapter{Реферат}

Работа: N стр., N табл., N рис., N источников, N приложений

\MakeUppercase{временные ряды, модели с переключением состояний, анализ поворотных точек экономических циклов}

Объекты исследования -- математические модели временных рядов, использующие переключение состояния; индикаторы экономики Республики Беларусь.

Цель работы -- исследование свойств моделей с переключением состояния (включая подклассы MS-VARX, IS-VARX) и их применение к задачам эконометрического моделирования на примере определения поворотных точек бизнес-цикла ВВП Республики Беларусь.

Методы исследования -- компьютерное моделирование временных рядов (индикаторы экономики Республики Беларусь и сгенерированные ряды). Используются как байесовские, так и классические статистические подходы.

В результате исследования получены новые модели для годовых темпов роста ВВП РБ, подтверждение опережающего характера индикатора экономических настроений (ИЭН). Также получены новые подходы к оценке параметров более общих RS-моделей.


% ОГЛАВЛЕНИЕ

\clearpage
\renewcommand{\contentsname}{Содержание}
\tableofcontents


% Перечень условных обозначений, символов и терминов
\fakechapter{Условные обозначения и термины}


\fakesection{Термины и сокращения}

\textbf{GDP} -- ВВП (gross domestic product, валовый внутренний продукт), базовый макроэкономический индикатор.

\textbf{ESI} -- ИЭН (economic sentiment index, индекс экономических настроений), опережающий макроэкономический индикатор.

\textbf{AR, VAR, VARX} -- авторегрессионные модели, соответственно: одномерная, векторная, векторная с экзогенными переменными.

\textbf{IS-} -- модель с независимым переключением состояний (от англ. independent switching).

\textbf{MS-} -- модель с Марковским переключением состояний (от англ. Markov switching).

\textbf{EM-алгоритм} -- итеративный алгоритм оценивания параметров, от английских названий этапов Expectation и Maximization.

\textbf{MCMC} -- Markov Chain Monte Carlo, алгоритм оценивания распределений путем генерации случайных траекторий цепей Маркова.

\textbf{NUTS} -- No-U-Turn Sampler, продвинутая версия MCMC, использующая информацию о градиентах и рекурсивный алгоритм остановки.

\textbf{trace, трейс} -- траектория (цепь Маркова) алгоритма MCMC, описывающая апостериорное распределение вероятности моделируемых величин.


\fakesection{Обозначения в формулах}

$y$ -- эндогенная (моделируемая) переменная, случайная величина, возможно векторная.

$x$ -- экзогенная переменная, возможно векторная.

$y_t, \: x_t$ -- реализация переменных в момент времени $t$.

$\hat{y}_t$ -- прогноз эндогенной переменной на момент времени $t$.

$l_t = l(t) \in \overline{1,L}$ -- латентная (ненаблюдаемая) переменная состояния.

$L$ -- количество классов состояния (режимов).

$\theta$ -- вектор параметров модели (из пространства $\Theta$).

$D$ -- обобщенное представление набора данных (наблюдений).

$F(\cdot)$ -- процесс/распределение для эндогенной переменной.

$S(\cdot)$ -- процесс/распределение для латентной переменной состояния.



% Введение
% Во «Введении» (объем до 3 страниц) обосновывается актуальность темы, ее значение, выбор направления исследования, показывается необходимость проведения исследований по данной теме для решения конкретной проблемы (задачи), развития конкретных направлений в соответствующих областях науки, отраслях экономики
\fakechapter{Введение}

Количество данных, собранные человечеством, растет с огромной скоростью \cite{idc_data_2025}. Значительная часть этих данных по своей природе собраны с учетом временной структуры (т. е. являются временными рядами). Однако при моделировании одного количества недостаточно, существуют другие недостатки -- данные пропущены, не стандартизированы, не обработаны и, важнее всего, не полностью описывают реальные процессы, которые моделируются. Эффекты ненаблюдаемых величин необходимо учитывать в процессе моделирования.

В данной работе представляется многостороннее исследование моделей временных рядов с переключением скрытого состояния (regime-switching models, RS-модели), в частности векторные авторегрессионные модели (семейства RS-VARX) с независимым (IS-VARX) или Марковским (MS-VARX) переключением состояний.
Рассматриваются классические подходы оценки таких моделей с помощью EM-алгоритмов, а также байесовские подходы с помощью вероятностного программирования и современного инструментария MCMC.

Проводятся вычислительно-симуляционные эксперименты на основании этих методов. В качестве конкретного применения RS-моделей рассматривается проблема оценки поворотных точек бизнес-цикла экономики Республики Беларусь. В качестве данных берутся месячные ряды реального ВВП (GDP) и опережающего индекса экономических настроений (ИЭН, ESI). С учетом разбиения бизнес-цикла на фазы <<спад>> и <<подъём>>, оцениваются модели, характеризующие смены этих фаз и прогнозирующие значения ВВП.

TODO: Integrate these two texts

Модели со скрытыми переменными (latent variables) по определению включают в себя структурное предположение: в моделируемом процессе существует хотя бы одна переменная, которая не наблюдается или не может наблюдаться, но которая влияет на наблюдаемые/измеримые переменные. Такие модели используются в экономике и эконометрике [CITE], машинном обучении (особенно при обработке естественного языка [CITE]), биологии, психологии и т. д.

В данной работе рассматриваются модели временных рядов, где скрытая переменная является дискретной и категориальной с возможными значениями $l \in \overline{1,L} = \{1,2,\dots,L\}$. Интерпретация этой переменной -- класс состояния (regime), который определяет подмодель, по которой определяются другие переменные. Чаще всего эти подмодели имеют одинаковую структуру, но параметры оцениваются отдельно для каждого класса. В таких случаях модели с переключением состояний (regime switching models / RS-модели) – подкласс моделей со структурными изменениями.

Для оценивания параметров таких моделей разработано множество методов. При наличии латентности в структуре модели сложно или невозможно получить аналитические решения в общей форме, поэтому используются итеративные алгоритмы. Самый популярный и классический вариант \cite{malNovopMSVARX, malNovopHiddenMarkov, rs_hamilton_palgrave} -- EM (Expectation Maximization) алгоритмы, в которых последовательно обновляется оценка параметров при максимизации функции условного правдоподобия конкретной модели. Альтернативный вариант -- использование алгоритмов, основанные на байесовских методах \cite{rs_persio2014, rs_hamilton_palgrave}. 

В данной работе рассматриваются и используются оба подхода (как классический, так и байесовский) для оценки параметров и классов состояния моделей.

\chapter{Эконометрические модели с переключением состояний и их применение в задачах анализа бизнес-цикла}


\section{Общая характеристика моделей с переключением состояния}
Модели с переключением состояния (далее – RS-модели) используются для исследования и прогнозирования временных рядов. Вектор эндогенных (моделируемых) переменных обозначим $y$, вектор экзогенных -- $x$, скрытую переменную класса состояния (из $L$ классов) -- $l \in \overline{1, L}$, номер периода наблюдения (из $T$ наблюдений) -- $t \in \overline{1,T}$.
Самая общая формулировка моделей RS-моделей для временных рядов следующая:
\begin{equation}
	y_t \sim F_{l(t)}(t, y_{t-1}, \dots, y_1, x_t, x_{t-1}, \dots, x_1) ,
\end{equation}
\begin{equation}
	l(t) = l_t \sim S(t, l_{t-1}, \dots, l_1, y_{t-1}, \dots, y_1, x_t, \dots, x_1) ,
\end{equation}

\noindent
где $l(t) = l_t$ -- класс состояния в момент времени $t$, $S(\cdot)$ -- функция распределения изменения состояния, а $\{F_l(\cdot)\}$ -- функции условного распределения $y$ при значении $l \in \overline{1,L}$. 

RS-модели, таким образом, включают очень широкий класс возможных моделей, однако на практике (в целях сходимости и возможности интерпретации) используются конкретные подклассы. В этой работе особое внимание уделим авторегрессионным моделям RS-VARX, которые описываются следующей функцией условного распределения:
\begin{equation}
	y_{t}=c_{l(t)} + \sum_{i=1}^{p} A_{i,l(t)} y_{t-i} + B_{l(t)} x_{t} + \eta_{t, l(t)} ,
\end{equation}

\noindent
где 
$y_t$ -- эндогенный вектор размерности $n$, 
$x_{t}$ -- экзогенная векторная переменная размерности $m$,
$p$ -- порядок авторегрессии, 
$c_{l}$ -- вектор констант,
$A_{i,l}$ ($n \times n$ матрицы) и $B_{l}$ ($n \times m$ матрицы) -- матрицы авторегрессии и регрессии соответственно,
и $\eta_{t, l} \sim N_n(0, \Sigma_{l}) $ -- нормально–распределенный белый шум.

% TODO: Rewrite to improve russian
Все переменные, индексированные с $l$, могут зависеть от текущего состояния (<<переключаются>>); для уменьшения количества параметров можно убрать это переключение для некоторых из переменных. Для каждого класса состояния выполняются требования VARX и между классами существует различие в хотя бы одном параметре \cite{malNovopMSVARX}.

На процесс состояния $S(\cdot)$ также накладываются модельные предположения. В работе рассматриваются модели с независимым переключением состояния IS-VARX:

\begin{equation}
	\label{eq:is_distro}
	l_t \sim \mathit{Cat}(L, \pi), \quad \sum_{i=1}^{L}{\pi_i} = 1, \pi_i > 0 ,
\end{equation}

\noindent
где $\pi$ -- вектор вероятности классов (размерности $L$).

Также рассматриваются модели с Марковским переключением MS-VARX. 
В этом случаи $l_t$ описывается однородной цепью Маркова  \cite{malNovopMSVARX}:

\begin{equation}
	l_t \sim \mathit{Cat}(L, M_{l(t-1), \cdot}),
	\quad 
	l_1 \sim \mathit{Cat}(L, \pi) ,
\end{equation}

\noindent
где $\pi$ -- вектор начальных вероятностей (с ограничениями как у \ref{eq:is_distro}), а $M$ -- матрица вероятности перехода классов (размерности $L \times L$) с условиями:

\begin{equation}
	\begin{multlined}
		M=
		\left[
			{
					\begin{array}{cccc}
						m_{1,1} & m_{1,2} & ... & m_{1,L} \\
						m_{2,1} & m_{2,2} & ... & m_{2,L} \\
						...     & ...     & ... & ...     \\
						m_{L,1} & m_{L,2} & ... & m_{L,L} \\
					\end{array}
				}
			\right]
		, \quad
		\sum_{i=1}^{L} m_{i,j} = 1 \quad \forall j \in \overline{1,L}
		,
		\\
		0 \le m_{i,j} \le 1 \quad \forall i, j \in \overline{1,L},
	\end{multlined}
\end{equation}

а $M_{i, \cdot}$ -- $i$-я строка матрицы. При $L=2$ можно упростить ее структуру:

\begin{equation}
	M=
	\left[ {
				\begin{array}{cc}
					\sigma_{1}   & 1-\sigma_{1} \\
					1-\sigma_{2} & \sigma_{2}   \\
				\end{array}
			} \right]
	, \quad 
	0 \le \sigma_{1} \le 1
	, \quad 
	0 \le \sigma_{2} \le 1
	.
\end{equation}

Эти модельные предположения о структуре процессов для $y_t$, $l_t$ позволяют использовать определенные алгоритмы оценки параметров, которые описаны далее. Для моделей RS-VARX будет удобно представить модель в регрессионной форме, следуя \cite{malNovopMSVARX} (сохраняя ранние обозначения):

\begin{equation}
	\label{eq:rs_varx_as_regression}
	y_t = \Pi_{l(t)} u_t + \eta_{l(t)} ,
\end{equation}

\noindent
где $ \Pi_{l(t)} = (A_{1, l(t)}, \dots, A_{p, l(t)}, B_{l(t)}) $ -- сжатая матрица параметров для класса $l(t)$, 
а $ u_t = (y_{t-1}, \dots, y_{t-p}, x_{t}) $ -- сжатый вектор лаговых значений и экзогенных переменных на момент времени $t$.

\section{Оценка параметров RS-VARX моделей с размеченной выборкой}

В случаи когда выборка размечена, т. е. когда известны значения $\{y_t, u_t, l_t\}, t \in \overline{1,T}$, возможно аналитически вывести функцию правдоподобия \cite{malNovopMSVARX}:

\begin{equation}
	\label{eq:rs_varx_loglike}
	\begin{multlined}
		\mathcal{L}(\theta_F; \{y_t\}, \{u_t\}, \{l_t\}) ={} \\
		\pi(l_1) q(y_1; u_1, \Pi_{l(1)}) 
		\prod\limits_{t=2}^{T}{ 
		\pi(l_t; l_{t-1}, \dots, l_1) q(y_t; u_t, \Pi_{l(t)}) 
		} ,
	\end{multlined}
\end{equation}

\noindent
где $\theta_F = (\Pi_1, \dots, \Pi_L)$ -- общий вектор параметров $y$ (для процесса $F(\cdot)$), $q(\cdot; u, \Pi_l)$ -- условная функция распределения $y$ для класса $l$ при значений $u$, а $\pi(l_t; l_{t-1}, \dots, l_1)$ - условная функция распределения $l$ при придыдущих значении (конкретизация функции $S(\cdot)$ ). В случае IS-VARX $\pi(l_t = k; \cdot) = \pi_k$, а в случае MS-VARX $\pi(l_t = k; l_{t-1}, \cdot) = M_{l(t-1), k}$.

Зная функцию правдоподобия, можно максимизировать ее (ее логарифм) и получить значения параметров $\Pi_l$ при фиксированных значениях $\{l_t\}$; см. вывод в \cite{malNovopMSVARX}.


\section{EM-алгоритмы для IS-VARX и MS-VARX}

Удобно обозначить параметры процесса $S(\cdot)$ за $\theta_S$, а процесса $F(\cdot)$ за $\theta_F$. На основании представления \ref{eq:rs_varx_as_regression} и функции правдоподобия \ref{eq:rs_varx_loglike} можно построить EM-алгоритм совместной оценки параметров $\theta = (\theta_F, \theta_S)$ и вектора состояний $D = (l_1, \dots, l_T)$ \cite{malNovopMSVARX}. Он состоит из начального шага и двух итеративных шагов (\textit{Expectation/``E''  step} и \textit{Maximization/``M'' step}) до сходимости:

\textit{Начальный шаг}. Устанавливаются начальные значения параметров $\theta^{(0)}$ (либо вектора состояний $D^{(0)}$) и целевую точность.

\textit{E step}. При фиксированном значении $\theta_F^{(k-1)}  = (\Pi_1^{(k-1)}, \dots, \Pi_L^{k-1})$ определяется вектор классов состояний по правилу максимума апостериори: 

\begin{equation}
	l_t^{(k)} = \arg\max_{l\in\overline{1,L}}
	q(y_t; u_t, \hat{\Pi}_{l}^{(k)})
\end{equation}

\textit{M step}. Оценка параметров $\theta^{(k)}$ при фиксированных оценках $l_t^{(k)}$.

\textit{Условие окончания}. Алгоритм заканчивается если разность логарифмических функции правдоподобия достаточно мала (сходимость) либо при исчерпании максимального количества итераций. Если условия не выполняются, возвращаемся на \textit{E step} \cite{malNovopMSVARX,malVARforCycles}.

Реализации EM-алгоритмов для MS-ARX и MS-VAR есть в библиотеках языков R, а также в пакете Statsmodels языка Python \cite{statsmodels}. На момент написания этой работы в свободном доступе нету реализации версии для MS-VARX.


\chapter{Применение методов машинного обучения для построения моделей}


\section{Байесовские методы моделирования и оценок}

Фундаментальной математической основой байесовских методов являются понятия условной вероятности \ref{eq:formula_fullprob} и формула Байеса \ref{eq:formula_bayes} ниже:

\begin{equation}
	\label{eq:formula_fullprob}
	P(A|B)=\frac{P(A,B)}{P(B)} ,
\end{equation}

\noindent
где $P(A|B)$ по определению вероятность события $A$ при условии наступления события $B$. В рамках байесовского подхода оценивания параметров предполагается, что наблюдаемые данные являются случайными величинами, распределенные по некоторому (возможно неизвестному) закону распределения; информация о значении параметров также является случайной величиной. Таким образом, вместо случайных событий рассматриваются функции плотности распределения параметров $p(\theta),  \theta \in \Theta$ и данных $p(D)$ (в дискретных и смешанных случаях аналогичные формулы). Формула Байеса приобретает следующий вид \ref{eq:formula_bayes}:

\begin{equation}
	\label{eq:formula_bayes}
	p(\theta|D) = \frac{p(D|\theta) p(\theta)}{p(D)} = \frac{p(D|\theta) p(\theta)}{\int\limits_{z\in\Theta}{p(D|z)p(z)dz}} ,
\end{equation}

\noindent
где $p(\theta)$ -- априорная (предполагаемая) плотность распределения параметра, $p(D|\theta)$ -- условная вероятность наблюдать данные D при заданном значении параметра, а $p(\theta|D)$ -- апостериорная (обновленная) плотность распределения. Знаменатель дроби -- нормализующий коэффициент, который не зависит от параметра $\theta$, и на практике его трудоемко или невозможно вычислить; часто переформулируют \ref{eq:formula_bayes} через ненормализованную плотность \ref{eq:formula_bayes_unnorm}:

\begin{equation}
	\label{eq:formula_bayes_unnorm}
	p(\theta|D) \propto p(D|\theta) p(\theta) .
\end{equation}

% TODO: fix russian, Kirushek doesn't know how to do this
В общем случае эти формулы аналитически не разрешаются, однако при использовании так называемых сопряженных априорных распределений (для определенных моделей) возможно получать апостериорные распределения в аналитическом виде. Поэтому, чаще всего, используют численные методы для получения аппроксимации апостериорных плотностей [CITE something?].


\section{Вероятностное программирование}

Вероятностное программирование (probabilistic programming, PP) -- парадигма программирования и средство определения вероятностных моделей программным кодом \cite{intro_to_pp}. Основная особенность этой парадигмы – явное или неявное представление задачи в виде совместной функций распределения всех случайных величин. Удобным представлением (конечномерной) задачи являются графовые вероятностные модели (probabilistic graphical models / PGM). Случайные величины или переменные представляются вершинами графа, а их связи (условные зависимости, детерминированные преобразования и т. д.) представляются ребрами графа \cite{intro_to_pp}. Далее в этой работе будут рассматриваться только подвид вероятностных моделей, байесовские сети, хотя другие представления (например, Марковские сети) тоже существуют.

Байесовские сети -- ациклические направленные вероятностные графы, описывающие совместное распределение всех переменных путем факторизации на независимые условные распределения. Например, моделью с $n$ случайными величинами $X_1, \dots, X_n$ соответствует граф из $n$ вершин и некоторыми направленными ребрами. Обозначим предков узла $X_i$ как $\mathit{parents}(X_i)$. Совместная функция распределения, вследствие условной независимости от других узлов, выражается произведением:

\begin{equation}
	P(X_1, \dots, X_n) = \prod_{i=1}^{n}{P(X_i | \mathit{parents}(X_i))} .
\end{equation}

Вероятностное программирование позволяет определять данные модели программным кодом, задавать априорное распределение вероятности стохастическим узлам и потом решать различные оптимизационные задачи (часто -- максимизация функции правдоподобия) относительно апостериорной плотности распределения. Методы оптимизации включают методы Монте Карло (включая MCMC и более продвинутые HMC/NUTS \cite{nuts_hoffman_gelman}), вариационные методы (variational inference) и другие специализированные методы.

Самые популярные языки и библиотеки, поддерживающие вероятностное программирование, являются Stan [CITE STAN], PyMC3 \cite{pymc3_2016}, Tensorflow Probability \cite{tfp_distributions}, Pyro, и BUGS; они все используют или поддерживают представление вероятностных моделей в качестве байесовской сети.


\section{Применение вероятностного программирования к RS-моделям}

В данной главе рассмотрены последовательно более сложные модели (оценка параметров многомерного нормального распределения, модель VAR и модель распределения пуассоновского с переключением состояния) для отображения главных особенностей вероятностного программирования. В третей главе применяется PP непосредственно к задаче оценки поворотных точек экономики РБ.

Все параметры рассматриваются как случайные величины, поэтому необходимо определить априорную плотность распределения $p_{prior}(\theta) = p(\theta)$ (для дискретных параметров используется функция вероятности). Результатом алгоритмов MCMC является <<трейсы>> (traces), которые являются оценкой апостериорного распределения $p_{posterior}(\theta) = p(\theta|D)$.

В данной работе используются пакеты PyMC3 \cite{pymc3_2016} и Arviz \cite{arviz_2019}, написанные на языке Python. В библиотеке PyMC3 при изображении байесовской сети в виде графа показывается класс этих априорные распределений.


\subsection{Простая модель нормального распределения}

Для ознакомления рассмотрим простейшую модель: оценка параметров нормального распределения. Рассмотрим выборку размера $T$ случайных векторов (скаляров) размерности $n$: $\{x_t\}, \quad t\in\overline{1,T}, \quad x_i \sim N_n(\mu, \Sigma)$. Необходимо оценить параметры $\mu$ и $\Sigma$. 

% TODO: Set aside formula (formatting)
Из классической статистики известно, что оптимальными, несмещенными оценками являются:

\begin{equation}
	\begin{multline}
		\hat{\mu}=\frac{1}{T}\sum\limits_{t=1}^{T}{x_t}, \\
		\hat{\Sigma}=\frac{1}{T-1}\sum\limits_{t=1}^{T}{(x_t-\hat{\mu})(x_t-\hat{\mu})^\top} . 
	\end{multline}
\end{equation}}

Если рассматривать с байесовской точки зрения, то сопряженными априорными распределениями являются нормальное (для $\mu$) и обратное распределение Уишарта (для $\Sigma$) [CITE STAN2]. Однако в целях вычислительной стабильности и скорости семплирования вместо распределения Уишатра используется положительная часть распределения Коши (в одномерном случае) и распределение LKJ (в многомерном случаи), следуя советам по практическому применению MCMC алгоритмов [CITE, CITE STAN2].

Было взято $T=40$ наблюдений из двухмерного нормального распределения с соответсвующими $\mu$ и $\Sigma$:

\begin{equation}
	\mu = 
	\begin{bmatrix}
		10 \\
		-5
	\end{bmatrix}
	\	, \quad
	\Sigma = 
	\begin{bmatrix} 
		9  & -2 \\
		-2 & 4 
	\end{bmatrix}
\end{equation}

Взяты неинформативные (широкие, плоские) априорные распределения для максимального приближение оценок к оценке максимального правдоподобия. На рис. \ref{fig:pp_mvn_graph} отображен граф этой модели.

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_mvn_graph.png}
	\caption{Граф байесовской модели для оценки параметров многомерного нормального распределения}
	\label{fig:pp_mvn_graph}
\end{figure}

Каждый <<трейс>> (набор цепей Маркова) в выводе алгоритма MCMC описывает апостериорное распределение рассматриваемых величин/параметров. На рис. \ref{fig:pp_mvn_trace} показаны трейсы для модели многомерного распределения описанная графом (рис. \ref{fig:pp_mvn_graph}). Для эффективности требуется, чтобы эти трейсы были скоординированы между цепями (т.е. иметь одинаковые распределения) и чтобы индивидуальные цепи были максимально некоррелированы [CITE STAN2]. По статистикам (см. приложения [REF, CITE own repo?]) и графикам видно, что эти требования выполняются.

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_mvn_trace.png}
	\caption{Трейсы модели многомерного нормального распределения}
	\label{fig:pp_mvn_trace}
\end{figure}

На рисунке \ref{fig:pp_mvn_mu_comparison} отображены гистограммы и оценки плотности значений наблюдений $\mathbf{X} = D$, истинное значение параметра, а также оценки значений методом максимального правдоподобия (MLE) и апостериорного среднего (posterior mean). Как видно, для неинформативных априорных значений эти оценки совпадают. На рисунке \ref{fig:pp_mvn_mu_hdi} отображены апостериорные распределения средних значений и 95\%-е интервалы по сравнению с истинным значением. Для матрицы ковариации можно такие же оценки рассмотреть на рисунке \ref{fig:pp_mvn_sigma_hdi}; видно, что совпадают оценки максимального правдоподобия и максимум апостериори, а среднее апостериорного распределения смещено.

Таким образом проведено сравнение моделирования классическими методами (максимального правдоподобия) с байесовскими методами вероятностного программирования (PP). Также подчеркнуты основные понятия и диаграммы PP, которые используются далее в работе.

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_mvn_mu_comparison.png}
	\caption{Сравнения гистограммы данных с оценками $\mu$ (KDE -- Kernal Density Estimation, метод локальной аппроксимации плотности)}
	\label{fig:pp_mvn_mu_comparison}
\end{figure}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_mvn_mu_hdi.png}
	\caption{Сравнение апостериорной оценки $\mu$ с настоящим значением}
	\label{fig:pp_mvn_mu_hdi}
\end{figure}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_mvn_sigma_hdi.png}
	\caption{Сравнение апостериорной оценки $\Sigma$ с настоящим значением}
	\label{fig:pp_mvn_sigma_hdi}
\end{figure}


\subsection{VAR model}

TODO: Add this


\subsection{Распределение Пуассона с переключением параметра}

Рассмотрим задачу построения и оценивания RS-модели с помощью методов вероятностного программирования. Для определения графа модели необходимо определить случайные процессы $S$ и $F_l$ в параметризованном виде:

\begin{equation}
	l \sim S(\theta_S, \cdot) ,
\end{equation}

\begin{equation}
	y \sim F_l(\theta_{F(l)},\cdot) ,
\end{equation}

\noindent
где $\theta = (\theta_S, \theta_{F(0)}, \dots, \theta_{F(L)}) $ -- общий вектор параметров модели. 

Не обязательно, чтобы эндогенный процесс $F(\cdot)$ RS модели следовал авторегрессионной, регрессионной или даже непрерывной зависимости. Для ознакомления с особенностями моделирования RS-моделей вероятностным программированием рассмотрим модель без внешних зависимостей эндогенной переменной: модель переключения параметра пуассоновского распределения на основании сгенерированных данных. Этот пример следует существующему \cite{blog_hidden_markov_ravinutala}, но значительная часть программного кода и все графики были доработаны автором.

Модель описывается переключением параметра $\lambda$ в пуассоновском распределении, на основании значения цепи Маркова:

\begin{equation}
	\label{eq:ms_pois_equation}
	\begin{aligned}
		y_t \sim \mathit{Pois}(\lambda_{l(t)}) , \\
		l_t \sim \mathit{Cat}(L, M_{l(t-1), \cdot}) .
	\end{aligned}
\end{equation}

Такая модель может описывать, например, количество заявок в промежуток времени в систему, у которой есть состояния <<малая интенсивность>> и <<большая интенсивность>>. Была сгенерирована выборка длиной $T=100$ с числом классов $L=2$ и следующими параметрами:

\begin{equation}
	\label{eq:ms_pois_coef_true}
	\lambda_1 = 5, 
	\lambda_2 = 10,
	M = \left[ {\begin{array}{cc}
					0.8 & 0.2 \\
					0.2 & 0.8
				\end{array} } \right]
	.
\end{equation}

На основании этого была построена следующая графовая модель, отображенная на рис. \ref{fig:pp_ms_pois_graph}:

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_ms_pois_graph.png}
	\caption{Граф модели процесса с переключающимся пуассоновским распределением}
	\label{fig:pp_ms_pois_graph}
\end{figure}

В качестве априорных распределений начальных состояний $\pi$ (на графе -- ``init\_probs’’) и матрицы перехода $M$ (на графе -- ``state\_trans’’) используется сопряженное распределение Дирихле с минимальной информативности; для $\lambda$ используется неинформативное Гамма-распределение со среднем значением 10 и отклонением 100. Для процесса ``states’’ необходимо было только определить логарифмическую функцию правдоподобия, описанная формулой \ref{eq:ms_loglike}:

\begin{equation}
	\label{eq:ms_loglike}
	\mathit{log}(\mathcal{L}(\pi, M; \{l_t\}))
	=
	\pi(l_1)
	\prod\limits_{t=2}^{T}{ 
	\pi(l_t; l_{t-1}, \dots, l_1)
	} .
\end{equation}

Одно важное явление, возникающее при работе с RS-моделями и алгоритмами MCMC – ``label switching’’, т. е. переключение между режимами в середине цепи MCMC. Во время семплирования есть вероятность взаимной замены, например, параметра режима 1 на параметр режима 2; в таком случае распределение дальнейших значений этих цепей будет отличаться от начального (т. к. они <<поменялись местами>>) и апостериорные значения параметров будут каким-то взвешенным среднем от исходных. Для простых моделей вроде этой, где есть достаточно четкая разделимость между классами, такое явление редкое; переключение значения происходило только между цепями. Для предотвращения явления ``label switching’’ в описанных моделях используется преобразование упорядочивания параметров.

На рис. \ref{fig:pp_ms_pois_trace} показаны результирующие трейсы, на рис.  \ref{fig:pp_ms_pois_ppc} -- график проверки апостериорных предсказаний модели, а на рис. \ref{fig:pp_ms_pois_fit} сравниваются предсказанные значения (классы состояния, эндогенной величины) с настоящими значениями. Как видно, трейсы удовлетворительные и апостериорные предсказания достаточно хорошо ложатся на истинные значения. Получены оценки коэффициентов \ref{eq:ms_pois_coef_est}, очень близкие к заданным \ref{eq:ms_pois_coef_true}:

\begin{equation}
	\label{eq:ms_pois_coef_est}
	\hat{\lambda}_1 = 4.703, 
	\hat{\lambda}_2 = 9.943,
	\hat{M}= \left[ {\begin{array}{cc}
					0.835 & 0.165 \\
					0.225 & 0.775
				\end{array} } \right]
	.
\end{equation}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_ms_pois_trace.png}
	\caption{Трейсы модели с пуассоновским переключением}
	\label{fig:pp_ms_pois_trace}
\end{figure}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_ms_pois_ppc.png}
	\caption{Диаграмма апостериорных предсказаний модели \ref{eq:ms_pois_equation}}
	\label{fig:pp_ms_pois_ppc}
\end{figure}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/gen/pp_ms_pois_fit.png}
	\caption{Сравнение предсказаний и истинных значений модели \ref{eq:ms_pois_equation}}
	\label{fig:pp_ms_pois_fit}
\end{figure}

При смены предположении о процессе $S(\cdot)$ или $F(\cdot)$ не требуется построение другого алгоритма оценки, а просто заменить соответствующий процесс. В последней главе будет рассматриваться процесс MS-ARX на реальных экономических данных; в реализации модели через вероятностное программирование необходимо было переопределить только сам эндогенный процесс.


\chapter{Применение MS-VARX к задаче оценки поворотных точек бизнес-цикла экономики Республики Беларусь}
\section{Экономические циклы и поворотные точки}

В рамках концепции экономического цикла или <<бизнес-цикла>> (business cycle), используемой в НБЭИ (Национальное бюро экономических исследований) США \cite{nberDevelopment}, подразумевается последовательная смена двух фаз базового экономического индикатора, называемых периодами <<роста>> (growth) и <<спада>> (recession) экономической активности \cite{oecdCycleExtraction}. Другие популярные определения экономических циклов могут состоять из трех или четырех фаз.

Моменты смены фазы роста на фазу спада, и наоборот, называются <<поворотными точками>> бизнес-цикла. Одной из ключевых задач анализа и прогнозирования экономической активности является разработка систем раннего обнаружения смены фаз экономических циклов.  Ранние работы \cite{esiMaking,esiExtra,mak_mal_bv_2018} [CHECK CITATIONS] рассматривали различные подходы оценивания поворотных точек для экономики Республики Беларусь. В качестве базового индикатора рассматривается реальное ВВП (GDP) Республики Беларусь.

В ходе НИР \cite{esiMaking} был построен композитный опережающий индикатор ESI (Economic Sentiment Index / Индекс Экономических Настроений / ИЭН). Для выделения циклических компонент ESI и GDP в ней был доработан метод, основанный на двойном применении фильтра Ходрика—Прескотта. Из циклической компоненты ряда уже нетрудно получить оценки поворотных точек \cite{esiMaking,esiExtra}. 

У этого подхода есть ряд недостатков \cite{ham_never_hp}, самым главным который является невозможность прогнозирования рядов в будущее (вследствие двусторонности фильтра Ходрика -- Прескотта). Автором была приведена альтернативная методика, основанная на использовании фильтра Хамильтона \cite{mak_mal_bv_2018}, которая исправляет часть недостатков.

Существует ешё один альтернативный подход оценивания поворотных точек, основанный на моделях с переключением состояний \cite{hamNewApproach}. В этой работе, в частности, используются авторегрессионные модели с переключением состояния и экзогенными переменными (класс MS-VARX) для которых разработаны алгоритмы оценивания параметров и классов состояния \cite{malNovopMSVARX,rs_persio2014,goutte_hal_00747479}. Каждое отдельное состояние $l$ интерпретируется как часть экономического цикла; например, при $L=2$, эти два класса интерпретируются как фазы роста и спада. 

Результаты представлены на основании работы автора \cite{mak_mal_bv_2020} и дополнительного исследования байесовскими методами.


\section{Описание исходных данных}

В качестве базового индикатора бизнес-цикла рассматривается реальный ВВП (GDP) Республики Беларусь в ценах 2014 г. в месячном исчислении; он же является моделируемой переменной. Вышеописанный Индекс Экономических Настроений (ESI) используется в качестве экзогенной переменной. Так как ESI является опережающим индикатором (поворотные точки ESI опережают поворотных точек GDP на 2-4 месяца \cite{esiMaking,esiExtra}), рассматривались варианты моделей со включением различных лагов ESI (опережение рассматривалось от 0 до 5 периодов).


\section{Исследование рядов GGDP, GESI статистическими тестами}

Для тестирования интегрированности рядов GGDP и GESI (и их первых разностей) использовались тесты, допускающие наличие структурных изменений. Используя тест BPUR (Breakpoint Unit Root), гипотеза об интегрированности с <<инновационными аномалиями>> (сдвигами) не была отклонена. С помощью теста Баи – Перрона (Bai – Perron tests for sequentially determined breaks) и построении моделей со структурными изменениями (Breakpoint Least Squares) выявлен феномен <<кобрейкинга>> (одновременного структурного изменения) рядов GGDP и GESI. Более подробно процедура описана в \cite{mak_mal_bv_2020}, где также построены две ARX модели (формулы 4 и 5 в статье), не включающие изменения в параметрах т. к.  структурные изменения в GGDP и GESI совпадают. Также было проведено тестирование на коинтегрированность этих рядов, в котором гипотеза о коинтеграции не отклонилась \cite{mak_mal_bv_2020}. 

Принятая методология определения фаз бизнес-цикла экономики Республики Беларусь предполагает две фазы (<<спад>> и <<подъем>>), поэтому фиксируется количество классов $L=2$, которые интерпретируются соответствующим образом. В данной работе везде использовался класс моделей MS-ARX вследствие предыдущих работ автора и руководителя по данной тематике \cite{mak_mal_bv_2018,malVARforCycles}.

Цель экспериментальной части \cite{mak_mal_bv_2020} состоит в оценивании предиктивных способностей моделей MS-ARX, включающие вышеописанный опережающий индикатор. Ряды GDP, ESI содержат сезонные эффекты. В представляемых моделях использовались годовые темпы ростов этих рядов GGDP и GESI соответственно, которые можно рассматривать как сезонно скорректированные ряды. Их циклические компоненты демонстрируют опережающий характер GESI\_C по отношению к GGDP\_C \cite{mak_mal_bv_2020}, см. рис. \ref{fig:bv_ggdp_cycles}.

\begin{figure}[H]
	% TODO: Change to Python graph for consistent style
	\includegraphics[width=\linewidth]{img/manual/bv_ggdp_cycles.png}
	\caption{Циклы годовых темпов роста ВВП (GGDP) и ИЭН (GESI)}
	\label{fig:bv_ggdp_cycles}
\end{figure}



\section{Эксперименты с MS-ARX и опережающим индикатором}

При моделировании GGDP рассматривались некоторые модели семейства MS-ARX, включающие различные структурные предположения и экзогенные переменные. Везде рассматривалось $L=2$ класса и порядок авторегрессии не более $p=2$, т. е. класс MS(2)-ARX(2). В дальнейших формулах используются обозначения $y_t = \text{GGDP}_t$, $x_t = \text{GESI}_t$, и $\eta_t$ -- инновационный процесс.

Из рассмотренных моделей, следующие сошлись и дали лучшие результаты:

\begin{equation}
	M.0. \quad y_t = c_{l(t)} + \alpha_{l(t), 1} y_{t-1} + \alpha_{l(t), 2} y_{t-2} + \eta_t .
\end{equation}

Модель $M.0$ не содержит экзогенных факторов и предполагает, что циклические изменения обусловлены аномалиями в инновационном процессе $\eta$ и ведут к изменениям среднего уровня GGDP.

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/manual/model_m0.png}
	\caption{Результаты модели $M.0$: предсказание эндогенной переменной (сверху), вероятности режимов (посередине), остатки модели (снизу)}
	\label{fig:sm_model_m0}
\end{figure}

Для моделей $M.1$ - $M.3$ отключено изменение в авторегрессионных коэффициентах $\alpha_i$; вследствие незначимости этих коэффициентов, они исключены в итоговых вариантах моделей.

% TODO: Проверить правильно ли это – может просто не включали изначально?

\begin{equation}	
	M.1. \quad y_t = c_{l(t)} + \alpha_1 y_{t-1} + \alpha_2 y_{t-2} + \beta_{l(t), 1} t + \eta_t .
\end{equation}

Модель $M.1$ допускает циклические изменения в трендовой компоненте. 

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/manual/model_m1.png}
	\caption{Результаты модели $M.1$: предсказание эндогенной переменной (сверху), вероятности режимов (посередине), остатки модели (снизу)}
	\label{fig:sm_model_m1}
\end{figure}

В основе $M.2$ лежит долгосрочная коинтеграционная зависимость между GGDP и GESI, включающая линейный тренд:

\begin{equation}
	M.2. \quad y_t = c_{l(t)} + \alpha_1 y_{t-1} + \alpha_2 y_{t-2} + \beta_{l(t), 1} t + \beta_{l(t), 2} x_{t} + \eta_t .
\end{equation}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/manual/model_m2.png}
	\caption{Результаты модели $M.2$: предсказание эндогенной переменной (сверху), вероятности режимов (посередине), остатки модели (снизу)}
	\label{fig:sm_model_m2}
\end{figure}

$M.3$ включает такую же структуру, однако включает опережающую экзогенную переменную GESI(-4):

\begin{equation}
	M.3. \quad y_t = c_{l(t)} + \alpha_1 y_{t-1} + \alpha_2 y_{t-2} + \beta_{l(t), 1} t + \beta_{l(t), 2} x_{t-4} + \eta_t .
\end{equation}

\begin{figure}[H]
	\includegraphics[width=\linewidth]{img/manual/model_m3.png}
	\caption{Результаты модели $M.3$: предсказание эндогенной переменной (сверху), вероятности режимов (посередине), остатки модели (снизу)}
	\label{fig:sm_model_m3}
\end{figure}

Все коэффициенты при экзогенных переменных зависят от класса состояния $l_t$.

В таблицах \ref{tbl:ggdp_model_params_reg} и \ref{tbl:ggdp_model_params_ms} приведены характеристики оцененных моделей, включая коэффициенты, интерпретацию фаз <<роста>> и <<падения>>, и вероятности переходов. На основании этих данных можно сделать следующие выводы:

\begin{enumerate}
	\item Свободный член и включенные в модели экзогенные переменные действительно подвержены циклическим изменениям во всех моделях.
	\item В моделях $M.0$, $M.1$, $M.2$ в состоянии <<спад>> GGDP чувствительна к изменениям в свободном члене и всех включенных переменных (тренд, GESI, авторегрессионная часть), а в состоянии <<рост>> влияет только свободный член.
	\item В модели $M.3$ с опережающей переменной GESI(-4) все коэффициенты значимые, и сама модель обладает наилучшей предиктивной способности при определении двух классов состоянии.
\end{enumerate}

\begin{table}[H]
	\begin{tabular}{l|ll|ll}
		\hline
		\multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Модель}}} & \multicolumn{1}{c}{\multirow{2}{*}{\textbf{Переменная}}} & \multicolumn{1}{c|}{\multirow{2}{*}{\textbf{Параметр}}} & \multicolumn{2}{c}{\textbf{Значение / p-статистика}}                                     \\
		\multicolumn{1}{c|}{}                                 & \multicolumn{1}{c}{}                                     & \multicolumn{1}{c|}{}                                   & \multicolumn{1}{c}{Фаза <<спад>>}                    & \multicolumn{1}{c}{Фаза <<рост>>} \\ \hline
		\multirow{3}{*}{$M.0$}                                & -                                                        & $c$                                                     & 100,7035/0,000                                       & 103,5599/0,000                    \\
		                                                      & GGDP[-1]                                                 & $\alpha_1$                                              & 0,4036/0,000                                         & 0,0829/0,743                      \\
		                                                      & GGDP[-2]                                                 & $\alpha_2$                                              & 0,5533/0,000                                         & -0,2713/0,178                     \\ \hline
		\multirow{2}{*}{$M.1$}                                & -                                                        & $c$                                                     & 104,3309/0,000                                       & 109,4102/0,000                    \\
		                                                      & t                                                        & $\beta_1$                                               & -0,0536/0,000                                        & 0,0050/0,840                      \\ \hline
		\multirow{3}{*}{$M.2$}                                & -                                                        & $c$                                                     & 92,415/0,000                                         & 101,6467/0,000                    \\
		                                                      & t                                                        & $\beta_1$                                               & -0,0690/0,000                                        & 0,0256/0,289                      \\
		                                                      & GESI                                                     & $\beta_2$                                               & 0,1373/0,000                                         & 0,0750/0,254                      \\ \hline
		\multirow{3}{*}{M.3}                                  & -                                                        & $c$                                                     & 73,7080/0,000                                        & 98,919/0,000                      \\
		                                                      & t                                                        & $\beta_1$                                               & -0,0622/0,000                                        & -0,1169/0,000                     \\
		                                                      & GESI[-4]                                                 & $\beta_2$                                               & 0,3569/0,000                                         & 0,1118/0,000                      \\ \hline
	\end{tabular}
	\caption{Сравнение регресионных параметров MS моделей}
	\label{tbl:ggdp_model_params_reg}
\end{table}

\begin{table}[H]
	\begin{tabular}{l|ll|ll|ll}
		\hline
		\multicolumn{1}{c|}{\textbf{Модель}} & \multicolumn{1}{c}{$\hat{M}_{0,0}$ / p-стат.} & \multicolumn{1}{c|}{$\hat{M}_{0,1}$} & \multicolumn{1}{c}{$\hat{M}_{1,0}$ / p-стат.} & \multicolumn{1}{c|}{$\hat{M}_{1,1}$} & \multicolumn{1}{c}{$\hat{\pi}_0$} & \multicolumn{1}{c}{$\hat{\pi}_1$} \\ \hline
		$M.1$                                & 0,9784/0,000                                  & 0,0216                               & 0,3430/0,204                                  & 0,6570                               & 0,614                             & 0,386                             \\
		$M.2$                                & 0,9611/0,000                                  & 0,0389                               & 0,2050/0,172                                  & 0,7950                               & 0,655                             & 0,345                             \\
		$M.3$                                & 0,9288/0,000                                  & 0,0712                               & 0,1163/0,124                                  & 0,8837                               & 0,620                             & 0,380                             \\ \hline
	\end{tabular}
	\caption{Сравнение параметров состояний MS моделей}
	\label{tbl:ggdp_model_params_ms}
\end{table}


Графическое представление результатов экспериментов дано на рисунках \ref{fig:sm_model_m0}, \ref{fig:sm_model_m1}, \ref{fig:sm_model_m2} и \ref{fig:sm_model_m3}. На них представлены:
\begin{itemize}
	\item динамика годовых темпов роста реально ВВП (GGDP),
	\item интервалы соответствующие классам <<роста>> и <<спада>>,
	\item прогнозы моделей для периода оценивания,
	\item условные прогнозы моделей вне этого периода (для валидации),
	\item график оценок вероятности режима 1 (raw -- прямая оценка, filtered -- условная от предыдущих значений, smoothed -- условная от всех значений),
	\item график остатков.
\end{itemize}


\section{MS-ARX в парадигме вероятностного программирования}

TODO: Important part!


% Заключение (выводы)
\fakechapter{Заключение}

TODO: Conclusion.


% Список использованных источников
% \fakechapter{Список использованных источников}
\printbibliography[title=Список использованных источников]
\addcontentsline{toc}{chapter}{Список использованных источников}
\markboth{Список использованных источников}{Список использованных источников}

% Графический материал

% Программы (при необходимости)

% Приложения (при необходимости)


\end{document}